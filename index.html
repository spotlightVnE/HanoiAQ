<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chất lượng không khí Hà Nội (Trung bình 2024)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
        
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        /* Chiều cao bản đồ linh hoạt theo kích thước màn hình */
        #map {
            height: clamp(280px, 55vh, 520px);
            border-radius: 0.75rem; /* góc bo mềm mại hơn */
        }
        
        /* Simple loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #fb923c; /* orange-400 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        /* --- LEGEND STYLES --- */
        #map-legend {
            margin-top: 1rem;
            padding: 0.85rem;
            border-radius: 0.75rem; 
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 0.85rem; 
            line-height: 1.4;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .legend-square {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            border: 1px solid #ccc; 
            flex-shrink: 0; /* Ngăn ô vuông bị co lại */
        }

        #ranking-table {
            width: 100%;
            table-layout: fixed;
        }

        #ranking-table th,
        #ranking-table td {
            word-break: normal;
            white-space: normal;
            hyphens: auto;
        }
        /* --------------------- */

        @media (max-width: 640px) {
            #map {
                height: 375px;
            }
            #map-legend {
                margin-top: 0.75rem;
                padding: 0.75rem;
                font-size: 0.8rem;
            }
            .legend-item {
                margin-bottom: 2px;
            }
            #ranking-table {
                font-size: 0.75rem;
            }
            #ranking-table th,
            #ranking-table td {
                padding: 0.45rem 0.3rem;
                font-size: 0.7rem;
            }
        }

    </style>
</head>
<body class="bg-gray-100 font-sans text-base md:text-lg leading-relaxed p-3 md:p-8">

    <div class="max-w-[1000px] mx-auto space-y-4 md:space-y-6">
        <main class="bg-white p-4 md:p-8 rounded-xl shadow-lg space-y-4 md:space-y-5">

            <div class="flex flex-col md:flex-row gap-3 md:gap-4">
                <div class="flex-1 space-y-1.5">
                    <input id="ward-search" type="search" placeholder="Tìm phường/xã..." class="w-full p-3 md:p-4 text-base md:text-lg border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" aria-label="Tìm kiếm phường hoặc xã" autocomplete="off" />
                    <div id="ward-suggestions" class="space-y-1 text-sm text-gray-600 hidden"></div>
                </div>
                <div class="flex-shrink-0 md:self-end">
                    <button id="location-btn" class="w-full md:w-auto bg-orange-500 text-white text-base md:text-lg font-bold px-4 py-2.5 md:px-6 md:py-3 rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                        Vị trí của tôi
                    </button>
                </div>
            </div>
            
            <div id="message-area" class="text-center text-gray-500 text-sm md:text-base mb-3 hidden"></div>

            <div id="results-state" class="space-y-4 md:space-y-5 hidden">
                <div class="flex flex-col items-center justify-center">
                    <div class="w-full text-center bg-orange-50 p-5 md:p-6 rounded-lg space-y-2.5 md:space-y-3">
                        <h3 class="text-lg md:text-xl text-gray-800">Không khí tại <span id="city-name" class="text-orange-500 font-bold"></span> ô nhiễm tương đương hút <span id="cigarette-count" class="text-orange-500 text-xl font-bold md:text-2xl">...</span> điếu thuốc</h3>
                        <div class="flex items-center justify-center gap-1 md:gap-3 flex-nowrap overflow-x-auto">
                            <button type="button" class="mode-btn px-3 md:px-5 py-2 md:py-3 rounded-full border text-sm md:text-lg font-semibold transition-colors duration-150 whitespace-nowrap" data-mode="daily">mỗi ngày</button>
                            <button type="button" class="mode-btn px-3 md:px-5 py-2 md:py-3 rounded-full border text-sm md:text-lg font-semibold transition-colors duration-150 whitespace-nowrap" data-mode="weekly">mỗi tuần</button>
                            <button type="button" class="mode-btn px-3 md:px-5 py-2 md:py-3 rounded-full border text-sm md:text-lg font-semibold transition-colors duration-150 whitespace-nowrap" data-mode="monthly">mỗi tháng</button>
                        </div>
                        <p id="population-info" class="text-base md:text-lg text-orange-600 font-medium"></p>
                    </div>
                </div>
                
            </div>

        </main>

        <section class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <h3 class="text-lg md:text-xl font-bold text-gray-700 mb-2 md:mb-3">Bản đồ chất lượng không khí</h3>
            <div id="map"></div>
            <div id="map-legend" class="text-gray-700"></div>
        </section>

        <section class="bg-white p-4 md:p-6 rounded-xl shadow-lg">
            <h3 class="text-lg md:text-xl font-bold text-gray-700 mb-2 md:mb-3">Xếp hạng chất lượng không khí</h3>
            <div class="grid gap-4 md:gap-6 md:grid-cols-2">
                <div>
                    <h4 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Tệ nhất</h4>
                    <ol id="top-worst-list" class="list-decimal list-inside space-y-1 text-gray-700"></ol>
                </div>
                <div>
                    <h4 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Tốt nhất</h4>
                    <ol id="top-best-list" class="list-decimal list-inside space-y-1 text-gray-700"></ol>
                </div>
            </div>
            <button id="toggle-table-btn" class="mt-4 px-4 py-3 rounded-lg border border-orange-400 text-orange-600 font-semibold hover:bg-orange-50 transition-colors duration-150">Xem toàn bộ phường xã</button>
            <div id="full-table-container" class="mt-4 hidden space-y-2.5 md:space-y-3.5">
                <div class="flex flex-wrap gap-2 md:gap-3 items-center">
                    <input id="ranking-search" type="search" placeholder="Tìm phường/xã..." class="flex-1 min-w-[220px] px-3 md:px-4 py-2.5 md:py-3 text-base md:text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400" />
                </div>
                <div class="overflow-x-auto">
                    <table id="ranking-table" class="divide-y divide-gray-200 text-xs md:text-sm">
                        <thead class="bg-gray-100 text-gray-600 uppercase tracking-wide text-sm">
                            <tr>
                                <th class="px-4 py-2 text-left">
                                    <button type="button" class="flex items-center gap-1" data-sort-key="rank" data-sort-default="asc">
                                        <span>Xếp hạng ô nhiễm</span>
                                        <span class="text-gray-400 text-sm" data-sort-indicator="rank"></span>
                                    </button>
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <button type="button" class="flex items-center gap-1" data-sort-key="name" data-sort-default="asc">
                                        <span>ĐVHC</span>
                                        <span class="text-gray-400 text-sm" data-sort-indicator="name"></span>
                                    </button>
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <button type="button" class="flex items-center gap-1" data-sort-key="aqi" data-sort-default="desc">
                                        <span>AQI</span>
                                        <span class="text-gray-400 text-sm" data-sort-indicator="aqi"></span>
                                    </button>
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <button type="button" class="flex items-center gap-1" data-sort-key="pm25" data-sort-default="desc">
                                        <span>PM2.5 (µg/m³)</span>
                                        <span class="text-gray-400 text-sm" data-sort-indicator="pm25"></span>
                                    </button>
                                </th>
                                <th class="px-4 py-2 text-left">
                                    <button type="button" class="flex items-center gap-1" data-sort-key="population" data-sort-default="desc">
                                        <span>Dân số (người)</span>
                                        <span class="text-gray-400 text-sm" data-sort-indicator="population"></span>
                                    </button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table-body" class="divide-y divide-gray-200 text-gray-700"></tbody>
                    </table>
                </div>
                <div class="flex flex-col md:flex-row items-center justify-between gap-3 text-sm md:text-base text-gray-700">
                    <div id="pagination-info" class="font-medium"></div>
                    <div class="flex gap-2">
                        <button id="prev-page-btn" class="px-4 py-2.5 text-base md:text-lg rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-150">Trang trước</button>
                        <button id="next-page-btn" class="px-4 py-2.5 text-base md:text-lg rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-150">Trang sau</button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-400 text-xs md:text-base">
            <p>Dữ liệu chất lượng không khí trung bình năm được tính toán từ trung bình các ngày trong năm, do <a href="https://geoi.edu.vn/vi/" target="_blank" rel="noopener noreferrer" class="text-orange-500 hover:underline">nhóm nghiên cứu GEOI</a> (Trường ĐH Công nghệ, ĐHQG Hà Nội) thực hiện.</p>
            <p>Cách quy đổi dựa trên <a href="http://berkeleyearth.org/archive/air-pollution-and-cigarette-equivalence/" target="_blank" rel="noopener noreferrer" class="text-orange-500 hover:underline">nghiên cứu của Berkeley Earth</a>, trong đó 1 điếu thuốc/ngày tương đương với nồng độ PM2.5 khoảng 22 µg/m³.</p>
            <p>Dữ liệu ranh giới phường/xã từ NXB Tài nguyên - Môi trường và Bản đồ Việt Nam. Bản đồ nền từ Google Satellite</p>
        </footer>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let map;
        let geoJsonLayer;
        let wardData; // Will hold our fetched GeoJSON
        let featureIndexByName = new Map();
        let suggestionSource = [];
        let layerByName = new Map();
        const wardSearchInput = document.getElementById('ward-search');
        const wardSuggestions = document.getElementById('ward-suggestions');
        const locationBtn = document.getElementById('location-btn');
        const messageArea = document.getElementById('message-area');
        const populationInfo = document.getElementById('population-info');
        const cityNameEl = document.getElementById('city-name');
        const aqiValueEl = document.getElementById('aqi-value');
        const aqiRankEl = document.getElementById('aqi-rank');
        const topWorstList = document.getElementById('top-worst-list');
        const topBestList = document.getElementById('top-best-list');
        const toggleTableBtn = document.getElementById('toggle-table-btn');
        const fullTableContainer = document.getElementById('full-table-container');
        const resultsState = document.getElementById('results-state');
        const rankingSearch = document.getElementById('ranking-search');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const paginationInfo = document.getElementById('pagination-info');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const cigaretteCountEl = document.getElementById('cigarette-count');
        const modeButtons = Array.from(document.querySelectorAll('.mode-btn'));
        const sortButtons = Array.from(document.querySelectorAll('button[data-sort-key]'));
        const mapLegendContainer = document.getElementById('map-legend');
        const sortIndicators = new Map();
        sortButtons.forEach(btn => {
            const key = btn.dataset.sortKey;
            const indicator = document.querySelector(`[data-sort-indicator="${key}"]`);
            if (key && indicator) {
                sortIndicators.set(key, indicator);
            }
        });
        if (wardSearchInput) {
            wardSearchInput.disabled = true;
        }
        if (wardSuggestions) {
            wardSuggestions.innerHTML = '<p class="text-gray-400 text-sm">Đang tải danh sách phường/xã...</p>';
        }

        const modeMultipliers = { daily: 1, weekly: 7, monthly: 30 };
        let baseCigarettes = 0;
        let currentMode = 'daily';
        let rankingData = [];
        let rankingByName = new Map();
        let currentSort = 'aqi_desc';
        const rowsPerPage = 10;
        let currentPage = 1;
        let currentSuggestions = [];
        let activeTooltip = null;

        const formatDecimal = (value, fractionDigits = 1) => {
            if (!Number.isFinite(value)) {
                return '—';
            }
            return value.toFixed(fractionDigits).replace('.', ',');
        };
        
        // Định nghĩa thang màu AQI cho Legend
        const aqiColorScale = [
            // Sắp xếp theo thứ tự giảm dần của chất lượng (tăng dần của AQI) để hiển thị trong legend
            { color: '#f39c12', range: '101 - 150', label: 'Kém' },
            { color: '#f1c40f', range: '51 - 100', label: 'Trung bình' },
            { color: '#2ecc71', range: '0 - 50', label: 'Tốt' }
        ];

        function renderMapLegend() {
            if (!mapLegendContainer) return;
            let html = '<div class="font-bold mb-2">Chỉ số chất lượng không khí (AQI)</div>';
            html += '<div class="space-y-1">';
            aqiColorScale.forEach(item => {
                html += `<div class="legend-item text-gray-700">
                            <div class="legend-square" style="background-color: ${item.color};"></div>
                            <div><span class="font-semibold">${item.range}</span> (${item.label})</div>
                         </div>`;
            });
            html += '</div>';
            mapLegendContainer.innerHTML = html;
        }

        // --- CORE FUNCTIONS ---

        /**
         * Normalizes geo properties that may use different keys.
         */
        function getWardName(properties = {}) {
            return properties.ten_phuong || properties.Name || properties.name || "Selected Area";
        }

        function getWardPopulation(properties = {}) {
            return parseNumericProperty(properties.Pop ?? properties.population ?? properties.pop);
        }

        // Ưu tiên trường 'AQI' cho chỉ số AQI
        function getWardAqi(properties = {}) {
            return parseNumericProperty(properties.AQI ?? properties.aqi_mean ?? properties.aqi ?? properties['Air Quality']);
        }

        // Ưu tiên trường 'PM2.5' cho nồng độ PM2.5
        function getWardPm25(properties = {}) {
            return parseNumericProperty(properties['PM2.5'] ?? properties.pm25_mean ?? properties.pm25 ?? properties['Air Quality']);
        }

        /**
         * Parses numbers that may arrive as strings using comma decimal separators.
         */
        function parseNumericProperty(value) {
            if (typeof value === 'number') {
                return value;
            }
            if (typeof value === 'string') {
                const normalized = value.replace(/\s/g, '').replace(/,/g, '.');
                const parsed = parseFloat(normalized);
                return Number.isFinite(parsed) ? parsed : 0;
            }
            return 0;
        }

        function updateModeButtons() {
            modeButtons.forEach(btn => {
                const isActive = btn.dataset.mode === currentMode;
                btn.className = `mode-btn px-3 md:px-5 py-2 md:py-3 rounded-full border text-sm md:text-lg font-semibold transition-colors duration-150 whitespace-nowrap ${isActive ? 'bg-orange-500 text-white border-orange-500 shadow' : 'bg-white text-gray-500 border-gray-300 hover:border-orange-300 hover:text-orange-600'}`;
            });
        }

        function updateCigaretteDisplay() {
            const multiplier = modeMultipliers[currentMode] ?? 1;
            const value = baseCigarettes * multiplier;
            if (cigaretteCountEl) {
                cigaretteCountEl.innerText = formatDecimal(value, 1);
            }
        }

        function setBaseCigarettes(value) {
            baseCigarettes = value;
            updateCigaretteDisplay();
            updateModeButtons();
        }

        function setMode(mode) {
            if (!modeMultipliers[mode]) return;
            currentMode = mode;
            updateModeButtons();
            updateCigaretteDisplay();
        }

        function showResults() {
            if (resultsState) {
                resultsState.classList.remove('hidden');
            }
        }

        function isMobileView() {
            return window.matchMedia('(max-width: 640px)').matches;
        }

        /**
         * Returns heatmap color based on AQI.
         */
        function getHeatmapColor(aqi) {
            if (aqi <= 50) return '#2ecc71';
            if (aqi <= 100) return '#f1c40f';
            if (aqi <= 150) return '#f39c12';
            if (aqi <= 200) return '#e74c3c';
            if (aqi <= 300) return '#8e44ad';
            return '#5b2c6f';
        }

        function getWardStyle(properties = {}) {
            const aqi = getWardAqi(properties);
            return {
                color: '#ffffff',
                weight: 1,
                opacity: 0.8,
                fillColor: getHeatmapColor(aqi),
                fillOpacity: 0.6
            };
        }

        function getTooltipContent(feature = {}) {
            const name = getWardName(feature.properties || {});
            const entry = rankingByName.get(name);
            const total = rankingData.length;
            if (entry && total > 0) {
                // Sửa: Làm tròn AQI về 0 số thập phân
                return `<div class="font-semibold text-base">${name}</div><div class="text-sm">AQI: ${formatDecimal(entry.aqi, 0)} · Hạng #${entry.rankWorst}/${total}</div>`;
            }
            const aqi = getWardAqi(feature.properties || {});
            // Sửa: Làm tròn AQI về 0 số thập phân
            const aqiText = formatDecimal(aqi, 0);
            return `<div class="font-semibold text-base">${name}</div><div class="text-sm">AQI: ${aqiText}</div>`;
        }

        function updateLayerTooltip(layer) {
            if (!layer || !layer.feature) return;
            if (isMobileView()) {
                if (layer.unbindTooltip) {
                    layer.unbindTooltip();
                }
                return;
            }
            const content = getTooltipContent(layer.feature);
            const tooltip = layer.getTooltip ? layer.getTooltip() : null;
            if (tooltip && tooltip.setContent) {
                tooltip.setContent(content);
            } else if (layer.bindTooltip) {
                layer.bindTooltip(content, { sticky: true, direction: 'auto' });
            }
        }

        function handleTooltipOpen(e) {
            if (isMobileView()) return;
            if (activeTooltip && activeTooltip !== e.tooltip && map) {
                map.closeTooltip(activeTooltip);
            }
            activeTooltip = e.tooltip;
        }

        function handleTooltipClose(e) {
            if (activeTooltip === e.tooltip) {
                activeTooltip = null;
            }
        }

        const sortDefaults = {
            rank: 'asc',
            name: 'asc',
            aqi: 'desc',
            pm25: 'desc',
            population: 'desc'
        };

        const sortComparatorMap = {
            rank_asc: (a, b) => a.rankWorst - b.rankWorst,
            rank_desc: (a, b) => b.rankWorst - a.rankWorst,
            name_asc: (a, b) => a.name.localeCompare(b.name, 'vi'),
            name_desc: (a, b) => b.name.localeCompare(a.name, 'vi'),
            aqi_desc: (a, b) => b.aqi - a.aqi,
            aqi_asc: (a, b) => a.aqi - b.aqi,
            pm25_desc: (a, b) => b.pm25 - a.pm25,
            pm25_asc: (a, b) => a.pm25 - b.pm25,
            population_desc: (a, b) => (b.population || 0) - (a.population || 0),
            population_asc: (a, b) => (a.population || 0) - (b.population || 0)
        };

        /**
         * Converts PM2.5 value to equivalent daily cigarettes.
         * Formula: 1 cigarette/day ≈ 22 µg/m³ of PM2.5
         */
        function pm25ToCigarettes(pm25) {
            if (typeof pm25 !== 'number' || pm25 < 0) {
                return 0;
            }
            return pm25 / 22;
        }
        
        /**
         * Fetches and loads the local GeoJSON data, then initializes the map.
         */
        async function initializeMapAndData() {
            try {
                // Fetch the local GeoJSON file
                const response = await fetch('./HanoiAQ.geojson');
                if (!response.ok) {
                    throw new Error(`Không thể tải HanoiAQ.geojson: ${response.statusText}`);
                }
                wardData = await response.json();
                buildFeatureLookups(wardData);
                layerByName = new Map();

                // Initialize the map
                const mapCenter = [21.0285, 105.8542]; // Center of Hanoi
                const hanoiBounds = L.latLngBounds([[20.7, 105.2], [21.3, 106.1]]);
                map = L.map('map', {
                    attributionControl: false,
                    maxBounds: hanoiBounds,
                    maxBoundsViscosity: 1.0,
                    minZoom: 9
                }).setView(mapCenter, 10);
                L.tileLayer('https://mt.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 18,
                    minZoom: 9
                }).addTo(map);
                map.on('drag', () => {
                    map.panInsideBounds(hanoiBounds, { animate: false });
                });
                map.on('tooltipopen', handleTooltipOpen);
                map.on('tooltipclose', handleTooltipClose);
                
                // Setup the ward search input
                initializeWardSearch(wardData);

                // Add GeoJSON layer
                geoJsonLayer = L.geoJSON(wardData, {
                    style: feature => getWardStyle(feature.properties),
                    onEachFeature: (feature, layer) => {
                        // Add click listener to each ward polygon
                        layer.on('click', () => {
                            const clickedName = getWardName(feature.properties);
                            const featureIndex = getFeatureIndexByName(clickedName);
                            if (featureIndex >= 0) {
                                selectWardByIndex(featureIndex, { fitBounds: false, layer });
                            } else {
                                updateUI(feature.properties);
                                highlightLayer(layer);
                            }
                        });

                        const layerName = getWardName(feature.properties);
                        if (layerName) {
                            layerByName.set(layerName, layer);
                        }

                        updateLayerTooltip(layer);
                    }
                }).addTo(map);

                // Zoom the map to fit the bounds of the GeoJSON layer
                map.fitBounds(geoJsonLayer.getBounds(), getMobileFitBoundsOptions());
                refreshMapLayout();

                populateRanking(wardData);

                // Add event listeners for controls
                locationBtn.addEventListener('click', onLocationClick);

                showMessage("Chọn một phường/xã từ ô tìm kiếm, bấm vào bản đồ hoặc dùng nút định vị để bắt đầu.", 'info');

            } catch (error) {
                console.error("Lỗi khởi tạo ứng dụng:", error);
                showMessage(error.message, 'error');
            }
        }
        
        /**
         * Clears previous highlights and highlights the selected layer
         */
        let lastHighlightedLayer = null;
        function highlightLayer(layer) {
            // Reset style of the previously highlighted layer
            if (lastHighlightedLayer) {
                geoJsonLayer.resetStyle(lastHighlightedLayer);
            }
            
            // Apply new highlight style
            if(layer) {
                layer.setStyle({
                    color: '#e85d04', // A darker orange
                    weight: 4,
                    fillOpacity: 0.6
                });
                layer.bringToFront();
                lastHighlightedLayer = layer;
            }
        }

        function getMobileFitBoundsOptions(baseOptions = {}) {
            if (!map || window.innerWidth > 640) {
                return baseOptions;
            }
            const size = map.getSize();
            const paddingValue = Math.round(Math.min(size.x, size.y) * 0.3);
            return {
                ...baseOptions,
                padding: L.point(paddingValue, paddingValue)
            };
        }

        function buildFeatureLookups(data) {
            featureIndexByName = new Map();
            suggestionSource = [];
            if (!data || !Array.isArray(data.features)) {
                return;
            }
            data.features.forEach((feature, index) => {
                const name = getWardName(feature.properties);
                if (!name) return;
                const normalized = name.trim().toLowerCase();
                if (!featureIndexByName.has(normalized)) {
                    featureIndexByName.set(normalized, index);
                }
                feature.properties.__featureIndex = index;
                suggestionSource.push({ name, normalized, index });
            });
            suggestionSource.sort((a, b) => a.name.localeCompare(b.name, 'vi'));
        }

        /**
         * Prepares the ward search input and default suggestions.
         */
        function initializeWardSearch(data) {
            if (!wardSearchInput || !wardSuggestions) return;
            const hasData = data && Array.isArray(data.features);
            wardSearchInput.value = '';
            wardSearchInput.disabled = !hasData;
            wardSearchInput.placeholder = hasData ? 'Tìm phường/xã...' : 'Không có dữ liệu';
            wardSuggestions.innerHTML = '';
            wardSuggestions.classList.toggle('hidden', true);
        }

        function getFeatureIndexByName(name = '') {
            if (!name) return -1;
            const normalized = name.trim().toLowerCase();
            return featureIndexByName.has(normalized) ? featureIndexByName.get(normalized) : -1;
        }

        function getLayerByName(name = '') {
            if (!name) return null;
            return layerByName.get(name) || null;
        }

        function updateWardSuggestions(query = '') {
            if (!wardSuggestions) return;
            const trimmedQuery = (query || '').trim();
            const hasQuery = trimmedQuery.length > 0;
            wardSuggestions.classList.toggle('hidden', !hasQuery);
            if (!hasQuery) {
                wardSuggestions.innerHTML = '';
                currentSuggestions = [];
                return;
            }
            if (!wardData || !Array.isArray(wardData.features)) {
                wardSuggestions.innerHTML = '<p class="text-gray-400 text-xs px-2">Đang tải dữ liệu...</p>';
                currentSuggestions = [];
                return;
            }

            if (suggestionSource.length === 0) {
                wardSuggestions.innerHTML = '<p class="text-gray-400 text-xs px-2 py-1">Chưa có dữ liệu để gợi ý.</p>';
                currentSuggestions = [];
                return;
            }

            const normalized = trimmedQuery.toLowerCase();
            let pool = suggestionSource.filter(entry => entry.normalized.includes(normalized));

            currentSuggestions = pool.slice(0, 3);

            if (currentSuggestions.length === 0) {
                wardSuggestions.innerHTML = '<p class="text-gray-400 text-xs px-2 py-1">Không tìm thấy gợi ý phù hợp.</p>';
                return;
            }

            wardSuggestions.innerHTML = currentSuggestions.map(item => {
                return `
                    <button type="button" class="w-full text-left px-3 py-1.5 rounded-md border border-gray-200 hover:border-orange-400 hover:bg-orange-50 focus:outline-none focus:ring-1 focus:ring-orange-400 transition text-sm" data-suggestion-index="${item.index}">
                        <span class="block font-medium text-gray-800 truncate">${item.name}</span>
                    </button>
                `;
            }).join('');
        }

        function selectWardByIndex(index, options = {}) {
            if (!wardData || !wardData.features || typeof index !== 'number' || index < 0 || index >= wardData.features.length) {
                return;
            }
            const feature = wardData.features[index];
            const name = getWardName(feature.properties);
            updateUI(feature.properties);
            if (wardSearchInput) {
                wardSearchInput.value = name;
            }
            if (options.keepSuggestions !== true && wardSuggestions) {
                wardSuggestions.innerHTML = '';
                wardSuggestions.classList.add('hidden');
                currentSuggestions = [];
            }

            const targetLayer = options.layer || getLayerByName(name);
            if (targetLayer) {
                if (options.fitBounds !== false && map && targetLayer.getBounds) {
                    map.fitBounds(targetLayer.getBounds(), getMobileFitBoundsOptions());
                }
                highlightLayer(targetLayer);
            }
        }

        function handleWardSearchSubmit(query) {
            const trimmed = (query || '').trim();
            if (!trimmed) return;
            const exactIndex = getFeatureIndexByName(trimmed);
            if (exactIndex >= 0) {
                selectWardByIndex(exactIndex);
                return;
            }
            if (currentSuggestions.length > 0) {
                selectWardByIndex(currentSuggestions[0].index);
                return;
            }
            showMessage('Không tìm thấy phường/xã khớp với tìm kiếm.', 'info');
        }

        /**
         * Updates the HTML elements with the data from a feature's properties.
         */
        function updateUI(properties) {
            // *** ASSUMPTIONS ***
            // Adjust these property keys to match your GeoJSON file
            const pm25 = getWardPm25(properties);
            const aqi = getWardAqi(properties);
            const name = getWardName(properties);
            const population = getWardPopulation(properties);
            const rankingEntry = rankingByName.get(name);
            
            // Lỗi đã được sửa: Tính toán điếu thuốc luôn dùng giá trị PM2.5
            const cigaretteCount = pm25ToCigarettes(pm25); 

            // Update text content
            if (wardSearchInput && name) {
                wardSearchInput.value = name;
            }
            if (cityNameEl) {
                cityNameEl.innerText = name;
            }
            if (aqiValueEl) {
                // Sửa: Làm tròn AQI về 0 số thập phân
                aqiValueEl.innerText = formatDecimal(aqi, 0);
            }
            if (aqiRankEl) {
                if (rankingEntry) {
                    aqiRankEl.innerText = `(xếp hạng #${rankingEntry.rankWorst} trên ${rankingData.length}, #1 là tệ nhất)`;
                } else {
                    aqiRankEl.innerText = `(xếp hạng —)`;
                }
            }
            setBaseCigarettes(cigaretteCount);

            if (populationInfo) {
                populationInfo.innerText = population > 0
                    ? `Có khoảng ${Math.round(population).toLocaleString('vi-VN')} người đang hít cùng bầu không khí này.`
                    : '';
            }

            showResults();

            // Clear any messages
            showMessage('', 'info');

            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(layer => {
                    if (getWardName(layer.feature.properties) === name) {
                        updateLayerTooltip(layer);
                    }
                });
            }
        }

        /**
         * Builds the AQI ranking datasets and renders summary lists.
         */
        function populateRanking(data) {
            if (!data || !data.features) {
                rankingData = [];
                if (topWorstList) topWorstList.innerHTML = '';
                if (topBestList) topBestList.innerHTML = '';
                if (rankingTableBody) rankingTableBody.innerHTML = '';
                return;
            }

            rankingData = data.features
                .map((feature, index) => {
                    const properties = feature.properties || {};
                    const name = getWardName(properties);
                    const aqi = getWardAqi(properties);
                    const pm25 = getWardPm25(properties);
                    const population = getWardPopulation(properties);
                    return {
                        name,
                        aqi,
                        pm25,
                        population,
                        feature,
                        featureIndex: index
                    };
                })
                .filter(entry => entry.name);

            rankingData.sort((a, b) => b.aqi - a.aqi);

            rankingByName = new Map();
            rankingData.forEach((entry, index) => {
                entry.rankWorst = index + 1;
                rankingByName.set(entry.name, entry);
            });

            if (topWorstList) {
                topWorstList.innerHTML = '';
                rankingData.slice(0, 3).forEach(entry => {
                    const li = document.createElement('li');
                    // Sửa: Làm tròn AQI về 0 số thập phân
                    li.textContent = `${entry.name}: AQI ${formatDecimal(entry.aqi, 0)}`;
                    topWorstList.appendChild(li);
                });
            }

            if (topBestList) {
                topBestList.innerHTML = '';
                const bestEntries = rankingData.slice(-3).reverse();
                bestEntries.forEach(entry => {
                    const li = document.createElement('li');
                    // Sửa: Làm tròn AQI về 0 số thập phân
                    li.textContent = `${entry.name}: AQI ${formatDecimal(entry.aqi, 0)}`;
                    topBestList.appendChild(li);
                });
            }

            currentPage = 1;
            refreshRankingTable();
            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(updateLayerTooltip);
            }

            if (resultsState && !resultsState.classList.contains('hidden') && cityNameEl && cityNameEl.innerText && cityNameEl.innerText !== '...') {
                const currentFeature = wardData.features.find(f => getWardName(f.properties) === cityNameEl.innerText);
                if (currentFeature) {
                    updateUI(currentFeature.properties);
                }
            }

            if (wardSearchInput) {
                updateWardSuggestions(wardSearchInput.value);
            }
        }

        /**
         * Renders the full ranking table with current filters and sort order.
         */
        function refreshRankingTable() {
            if (!rankingTableBody) return;

            let rows = rankingData.slice();

            const searchTerm = rankingSearch ? rankingSearch.value.trim().toLowerCase() : '';
            if (searchTerm) {
                rows = rows.filter(entry => entry.name.toLowerCase().includes(searchTerm));
            }

            if (!sortComparatorMap[currentSort]) {
                currentSort = 'aqi_desc';
            }

            rows.sort(sortComparatorMap[currentSort]);

            const totalRows = rows.length;
            const totalPages = totalRows === 0 ? 1 : Math.ceil(totalRows / rowsPerPage);
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageRows = rows.slice(start, end);

            rankingTableBody.innerHTML = '';

            if (pageRows.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="px-4 py-4 text-center text-gray-500">Không có dữ liệu phù hợp.</td>`;
                rankingTableBody.appendChild(tr);
            } else {
                pageRows.forEach(entry => {
                    const tr = document.createElement('tr');
                    // Sửa: Làm tròn AQI về 0 số thập phân
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-gray-700">#${entry.rankWorst}</td>
                        <td class="px-4 py-3 font-semibold text-gray-800">${entry.name}</td>
                        <td class="px-4 py-3 text-gray-700">${formatDecimal(entry.aqi, 0)}</td>
                        <td class="px-4 py-3 text-gray-700">${formatDecimal(entry.pm25, 1)}</td>
                        <td class="px-4 py-3 text-gray-700">${entry.population > 0 ? Math.round(entry.population).toLocaleString('vi-VN') : '—'}</td>
                    `;
                    rankingTableBody.appendChild(tr);
                });
            }

            updatePaginationControls(totalRows, totalPages, start, Math.min(end, totalRows));
            updateSortIndicators();
        }

        function setSort(sortValue) {
            if (!sortComparatorMap[sortValue]) {
                sortValue = 'aqi_desc';
            }
            currentSort = sortValue;
            currentPage = 1;
            refreshRankingTable();
        }

        function toggleSortForKey(key) {
            if (!key) return;
            const [activeKey, activeDirection] = currentSort.split('_');
            let nextDirection;
            if (activeKey === key) {
                nextDirection = activeDirection === 'asc' ? 'desc' : 'asc';
            } else {
                nextDirection = sortDefaults[key] || 'asc';
            }
            const candidate = `${key}_${nextDirection}`;
            setSort(sortComparatorMap[candidate] ? candidate : 'aqi_desc');
        }

        function updateSortIndicators() {
            const [activeKey, activeDirection] = currentSort.split('_');
            sortIndicators.forEach((indicator, key) => {
                if (key === activeKey) {
                    indicator.textContent = activeDirection === 'asc' ? '▲' : '▼';
                    indicator.classList.remove('text-gray-400');
                    indicator.classList.add('text-orange-500');
                } else {
                    indicator.textContent = '';
                    indicator.classList.remove('text-orange-500');
                    indicator.classList.add('text-gray-400');
                }
            });
        }

        function updatePaginationControls(totalRows, totalPages, startIndex, endIndex) {
            if (paginationInfo) {
                if (totalRows === 0) {
                    paginationInfo.textContent = 'Không có kết quả nào.';
                } else {
                    const displayStart = startIndex + 1;
                    const displayEnd = endIndex;
                    paginationInfo.textContent = `Hiển thị ${displayStart.toLocaleString('vi-VN')} – ${displayEnd.toLocaleString('vi-VN')} trong tổng số ${totalRows.toLocaleString('vi-VN')} phường/xã · Trang ${currentPage}/${totalPages}`;
                }
            }
            if (prevPageBtn) {
                prevPageBtn.disabled = currentPage <= 1;
                const disablePrev = currentPage <= 1;
                prevPageBtn.classList.toggle('opacity-50', disablePrev);
                prevPageBtn.classList.toggle('cursor-not-allowed', disablePrev);
            }
            if (nextPageBtn) {
                nextPageBtn.disabled = currentPage >= totalPages;
                const disableNext = currentPage >= totalPages;
                nextPageBtn.classList.toggle('opacity-50', disableNext);
                nextPageBtn.classList.toggle('cursor-not-allowed', disableNext);
            }
        }

        /**
        * Xử lý sự kiện khi người dùng bấm nút "Vị trí của tôi".
         */
        function onLocationClick() {
            if (!navigator.geolocation) {
                showMessage("Trình duyệt của bạn không hỗ trợ xác định vị trí.", 'error');
                return;
            }
            
            showMessage("Đang lấy vị trí của bạn...", 'info');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const userPoint = turf.point([longitude, latitude]);
                    
                    let foundWard = null;
                    let foundLayer = null;

                    // Duyệt các lớp bản đồ để tìm vùng chứa điểm của người dùng
                    geoJsonLayer.eachLayer(layer => {
                        if (foundWard) return; // Đã tìm thấy thì dừng
                        
                        const isInside = turf.booleanPointInPolygon(userPoint, layer.feature.geometry);
                        
                        if (isInside) {
                            foundWard = layer.feature;
                            foundLayer = layer;
                        }
                    });

                    if (foundWard) {
                        const targetName = getWardName(foundWard.properties);
                        const featureIndex = getFeatureIndexByName(targetName);
                        if (featureIndex >= 0) {
                            selectWardByIndex(featureIndex, { layer: foundLayer });
                        } else {
                            updateUI(foundWard.properties);
                            if (foundLayer) {
                                map.fitBounds(foundLayer.getBounds(), getMobileFitBoundsOptions());
                                highlightLayer(foundLayer);
                            }
                        }
                    } else {
                        showMessage("Vị trí của bạn nằm ngoài phạm vi bản đồ các phường/xã của Hà Nội.", 'warn');
                    }
                },
                () => {
                    showMessage("Không thể lấy vị trí. Vui lòng kiểm tra quyền truy cập vị trí của trình duyệt.", 'error');
                }
            );
        }
        
        /**
         * Displays a message to the user.
         */
        function showMessage(message, type = 'info') {
            messageArea.textContent = message;
            
            // Remove old colors
            messageArea.classList.remove('text-red-500', 'text-yellow-500', 'text-gray-500', 'hidden');
            
            if (!message) {
                messageArea.classList.add('hidden');
                return;
            }

            // Add new color based on type
            if (type === 'error') {
                messageArea.classList.add('text-red-500');
            } else if (type === 'warn') {
                messageArea.classList.add('text-yellow-500');
            } else {
                messageArea.classList.add('text-gray-500');
            }
        }


        // --- APP START ---

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                setMode(mode);
            });
        });

        if (toggleTableBtn && fullTableContainer) {
            toggleTableBtn.addEventListener('click', () => {
                const isHidden = fullTableContainer.classList.toggle('hidden');
                toggleTableBtn.textContent = isHidden ? 'Xem toàn bộ bảng' : 'Ẩn bảng';
            });
        }

        if (wardSearchInput) {
            wardSearchInput.addEventListener('input', (event) => {
                updateWardSuggestions(event.target.value);
            });
            wardSearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleWardSearchSubmit(event.target.value);
                }
            });
        }

        if (wardSuggestions) {
            wardSuggestions.addEventListener('click', (event) => {
                const target = event.target.closest('button[data-suggestion-index]');
                if (!target) return;
                const index = Number(target.dataset.suggestionIndex);
                if (!Number.isNaN(index)) {
                    selectWardByIndex(index);
                }
            });
        }

        if (rankingSearch) {
            rankingSearch.addEventListener('input', () => {
                currentPage = 1;
                refreshRankingTable();
            });
        }
        sortButtons.forEach(btn => {
            btn.addEventListener('click', () => toggleSortForKey(btn.dataset.sortKey));
        });

        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', () => {
                currentPage = Math.max(1, currentPage - 1);
                refreshRankingTable();
            });
        }
        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', () => {
                currentPage += 1;
                refreshRankingTable();
            });
        }

        function refreshMapLayout() {
            if (map) {
                map.invalidateSize();
            }
            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(updateLayerTooltip);
            }
        }

        window.addEventListener('resize', refreshMapLayout);

        updateModeButtons();
        updateCigaretteDisplay();
        
        // When the page finishes loading, initialize the app
        renderMapLegend();
        window.onload = initializeMapAndData;

    </script>

</body>
</html>
