<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chất lượng không khí Hà Nội (Trung bình 2024)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
        
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* --- MAP STYLES --- */
        #map {
            min-height: 280px;
            height: 100%;
            flex: 1 1 auto;
            border-radius: 0.75rem;
            width: 100%;
            z-index: 1;
        }

        /* --- SEARCH INPUT STYLES --- */
        #ward-search {
            min-width: 60px;
            width: auto;
            transition: all 0.2s ease;
            background: transparent;
            border-radius: 0;
            padding: 0 0.25rem;
            max-width: 100%;
        }
        
        #ward-search:focus {
            background: rgba(255, 237, 213, 0.3);
        }

        #ward-search.has-clear {
            padding-right: 1.5rem;
        }

        #clear-ward-search {
            transition: opacity 120ms ease, color 120ms ease;
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        #ward-suggestions::-webkit-scrollbar {
            width: 6px;
        }
        #ward-suggestions::-webkit-scrollbar-thumb {
            background-color: #fb923c;
            border-radius: 3px;
        }

        .ward-search-wrapper {
            display: inline-flex;
            flex-wrap: wrap;
            align-items: baseline;
            max-width: 100%;
            gap: 0.25rem;
        }

        @media (max-width: 640px) {
            .ward-search-wrapper {
                display: block;
                width: 100%;
            }
            #ward-search {
                width: 100% !important;
            }
            #map-legend {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            #map-legend .legend-grid {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.5rem 0.75rem;
            }
            .legend-column {
                gap: 0.4rem;
                flex-direction: column;
                align-items: flex-start;
            }
            .legend-item {
                font-size: 0.65rem;
                align-items: flex-start;
            }
            .legend-label {
                font-size: 0.65rem;
                line-height: 1.1;
                flex-direction: column;
                align-items: flex-start;
                gap: 0;
            }
            .legend-label-range {
                display: block;
                font-size: 0.62rem;
                font-weight: 500;
                line-height: 1.1;
            }
            .hero-section {
                padding: 0.9rem 0.85rem 1.15rem !important;
            }
            .hero-section h1 {
                font-size: 1.2rem;
                line-height: 1.4;
            }
            .hero-section #cigarette-count {
                font-size: 2.5rem;
            }
            .hero-section .mode-btn {
                font-size: 0.75rem;
                padding: 0.35rem 0.7rem;
            }
            .hero-layout {
                gap: 0.75rem !important;
            }
            .hero-stats {
                gap: 0.6rem !important;
            }
            .page-stack > :not([hidden]) ~ :not([hidden]) {
                margin-top: 0.45rem !important;
            }
            .page-stack {
                padding: 0 !important;
                gap: 0.45rem !important;
            }
            .mobile-compact {
                padding: 0.85rem 1rem !important;
            }
            .map-card {
                padding-top: 0.6rem !important;
                padding-bottom: 0.75rem !important;
            }
            .map-card-header {
                padding: 0.25rem 0.2rem !important;
                margin-bottom: 0.3rem !important;
            }
            .ranking-table-scroll {
                overflow: visible !important;
                max-height: none !important;
            }
            .mobile-compact h3,
            .mobile-compact h4 {
                font-size: 0.95rem;
            }
            #ranking-panel-body {
                min-height: 280px;
            }
            #ranking-search {
                font-size: 0.8rem;
            }
            #ranking-table th,
            #ranking-table td {
                font-size: 0.72rem;
                padding: 0.35rem 0.25rem;
            }
            section.mobile-compact p {
                font-size: 0.72rem;
            }
        }

        /* --- GLOBAL & LEGEND --- */
        html, body {
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            #map { height: 350px; }
        }

        #map-legend {
            margin-top: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem; 
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 0.8rem; 
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }
        
        #map-legend .legend-heading {
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            font-size: 0.72rem;
            margin-right: 0.5rem;
        }

        #map-legend .legend-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem 1.25rem;
        }

        .legend-column {
            display: flex;
            flex-direction: row;
            gap: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.78rem;
            color: #4b5563;
        }

        .legend-label {
            font-weight: 600;
            display: inline-flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: baseline;
        }

        .legend-label-text {
            display: inline;
        }

        .legend-label-range {
            display: inline;
            font-weight: 500;
        }

        .legend-square {
            width: 36px;
            height: 8px;
            border-radius: 99px;
            margin-bottom: 2px;
        }

        .app-shell {
            min-height: 100vh;
        }

        @media (min-width: 769px) {
            .app-shell {
                height: 100vh;
                overflow: hidden;
            }
        }

        @media (max-width: 768px) {
            .app-shell {
                height: auto !important;
                overflow: auto !important;
            }
            .app-scroll {
                overflow: visible !important;
                min-height: auto !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 leading-relaxed min-h-screen flex flex-col app-shell">

    <div class="w-full flex-1 flex flex-col space-y-4 px-2 md:px-4 py-3 md:py-4 overflow-hidden min-h-0 app-scroll page-stack">
        
        <main class="bg-white rounded-2xl shadow-sm border border-gray-200 shrink-0">
            
            <div id="message-area" class="text-center text-gray-500 text-sm hidden py-2 bg-gray-50"></div>

            <div id="results-state" class="transition-all duration-300">
                
                <div class="px-6 pt-8 pb-8 md:px-10 hero-section">
                    <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 hero-layout">
                        
                        <div class="flex-1 space-y-2">
                            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 leading-tight">
                                Hít thở không khí ô nhiễm tại 
                                <span class="ward-search-wrapper relative inline-block group align-baseline text-orange-600">
                                    <input id="ward-search" type="text" 
                                        class="border-b-4 border-orange-400/50 focus:border-orange-500 font-extrabold placeholder-orange-300/70 focus:outline-none" 
                                        placeholder="phường/xã" autocomplete="off" />
                                    
                                    <button id="clear-ward-search" type="button" 
                                        class="text-gray-400 hover:text-orange-500 hidden p-0.5 shadow-sm"
                                        aria-label="Xóa">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    
                                    <div id="ward-suggestions" class="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 max-h-60 overflow-y-auto hidden z-50 text-left text-base font-normal"></div>
                                </span>
                                <br class="hidden md:block" />
                                tương đương hút
                            </h1>
                            <div id="population-info-desktop" class="hidden md:block">
                                <p id="population-info" class="text-sm text-gray-500 font-medium"></p>
                            </div>
                        </div>

                        <div class="flex flex-col items-start md:items-end gap-3 hero-stats">
                            <div class="flex items-baseline gap-2">
                                <span id="cigarette-count" class="text-5xl md:text-6xl font-black text-orange-500 tracking-tight leading-none">...</span>
                                <span class="text-xl md:text-2xl font-bold text-orange-500">điếu thuốc</span>
                            </div>
                            
                            <div class="inline-flex bg-gray-100 p-1 rounded-lg">
                                <button type="button" class="mode-btn px-4 py-1.5 rounded-md text-sm font-bold transition-all duration-200" data-mode="daily">mỗi ngày</button>
                                <button type="button" class="mode-btn px-4 py-1.5 rounded-md text-sm font-bold transition-all duration-200" data-mode="weekly">mỗi tuần</button>
                                <button type="button" class="mode-btn px-4 py-1.5 rounded-md text-sm font-bold transition-all duration-200" data-mode="monthly">mỗi tháng</button>
                            </div>
                            <div id="population-info-mobile" class="w-full md:hidden text-left text-gray-500 text-sm font-medium pt-1"></div>
                        </div>

                    </div>
                </div>
            </div>
        </main>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-1 overflow-hidden min-h-0 app-scroll">
            
            <section class="bg-white px-3 py-3 md:px-4 md:py-4 rounded-2xl shadow-sm lg:col-span-2 border border-gray-200 flex flex-col h-full overflow-hidden min-h-0 app-scroll mobile-compact map-card">
                <div class="flex justify-between items-center mb-3 px-1 map-card-header">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="hidden sm:inline">Bản đồ chất lượng không khí trung bình năm 2024</span>
                        <span class="sm:hidden">Bản đồ chất lượng không khí 2024</span>
                    </h3>
                </div>
                <div id="map" class="flex-1 min-h-[240px]"></div>
                <div id="map-legend"></div>
            </section>

            <div class="flex flex-col gap-4 h-full overflow-hidden min-h-0">
                <section class="bg-white px-4 py-4 rounded-2xl shadow-sm border border-gray-200 flex flex-col flex-1 h-full overflow-hidden min-h-0 app-scroll mobile-compact">
                    <h3 id="ranking-title" class="text-lg font-bold text-gray-800 mb-3">Xếp hạng nhanh</h3>
                    
                    <div id="ranking-panel-body" class="flex-1 relative min-h-[360px] overflow-hidden">
                        <div id="ranking-quick-view" class="absolute inset-0 overflow-y-auto pr-1 space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-5 bg-red-500 rounded-full"></span>
                                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide">Tệ nhất</h4>
                                </div>
                                <ol id="top-worst-list" class="list-decimal list-inside space-y-2 text-sm text-gray-700 font-medium bg-red-50/50 p-3 rounded-lg border border-red-100"></ol>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="w-1.5 h-5 bg-green-500 rounded-full"></span>
                                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide">Tốt nhất</h4>
                                </div>
                                <ol id="top-best-list" class="list-decimal list-inside space-y-2 text-sm text-gray-700 font-medium bg-green-50/50 p-3 rounded-lg border border-green-100"></ol>
                            </div>
                        </div>

                        <div id="full-table-container" class="hidden absolute inset-0 flex flex-col gap-3 bg-white z-10">
                            <input id="ranking-search" type="search" placeholder="Tìm tên phường/xã..." 
                                class="w-full px-4 py-2 text-sm border border-gray-200 bg-gray-50 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 transition-shadow" />

                            <div class="flex-1 overflow-hidden border border-gray-100 rounded-lg">
                                <div class="h-full overflow-auto custom-scrollbar ranking-table-scroll">
                                    <table id="ranking-table" class="w-full divide-y divide-gray-100 text-sm">
                                        <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-[10px] font-semibold sticky top-0">
                                            <tr>
                                                <th class="px-3 py-2 text-left bg-gray-50">
                                                    <button type="button" class="hover:text-orange-600 flex items-center gap-1" data-sort-key="name">
                                                        Tên ĐVHC <span data-sort-indicator="name"></span>
                                                    </button>
                                                </th>
                                                <th class="px-3 py-2 text-left bg-gray-50">
                                                    <button type="button" class="hover:text-orange-600 flex items-center gap-1" data-sort-key="aqi">
                                                        AQI <span data-sort-indicator="aqi">▼</span>
                                                    </button>
                                                </th>
                                                <th class="px-3 py-2 text-left bg-gray-50">
                                                    <button type="button" class="hover:text-orange-600 flex items-center gap-1" data-sort-key="pm25">
                                                        PM2.5 (µg/m³) <span data-sort-indicator="pm25"></span>
                                                    </button>
                                                </th>
                                                <th class="px-3 py-2 text-left bg-gray-50">
                                                    <button type="button" class="hover:text-orange-600 flex items-center gap-1" data-sort-key="population">
                                                        Dân số <span data-sort-indicator="population"></span>
                                                    </button>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="ranking-table-body" class="divide-y divide-gray-50 text-gray-700 bg-white"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500 pt-1">
                                <div id="pagination-info">Trang 1</div>
                                <div class="flex gap-2">
                                    <button id="prev-page-btn" class="px-2 py-1 rounded border hover:bg-gray-50 disabled:opacity-30">Trước</button>
                                    <button id="next-page-btn" class="px-2 py-1 rounded border hover:bg-gray-50 disabled:opacity-30">Sau</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="toggle-table-btn" class="w-full mt-3 py-2.5 rounded-xl bg-gray-50 hover:bg-orange-50 text-gray-600 hover:text-orange-600 text-sm font-bold transition-colors border border-gray-200 hover:border-orange-200">
                        Xem chi tiết tất cả
                    </button>
                </section>

                <section class="bg-white px-4 py-4 rounded-xl shadow-sm border border-gray-200 text-[11px] text-gray-400 leading-relaxed space-y-2 mobile-compact">
                    <p>Dữ liệu chất lượng không khí trung bình năm theo phường, xã được tính toán bởi <a href="https://geoi.edu.vn/vi/" target="_blank" class="text-orange-500 hover:underline">nhóm nghiên cứu GEOI</a> (Trường Đại học Công nghệ, Đại học Quốc gia Hà Nội).</p>
                    <p>Quy đổi sang số điếu thuốc do VnExpress thực hiện, dựa trên nghiên cứu của <a href="http://berkeleyearth.org/archive/air-pollution-and-cigarette-equivalence/" target="_blank" class="text-orange-400 hover:underline">Berkeley Earth</a>. Trong đó, mỗi điếu thuốc một ngày tương đương khoảng 22 µg/m³ nồng độ PM2.5.</p>
                    <p>Dữ liệu dân số và ranh giới phường xã từ NXB Tài nguyên - Môi trường và Bản đồ Việt Nam. Bản đồ nền của Google Satellite.</p>
                </section>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let map;
        let geoJsonLayer;
        let wardData; 
        let featureIndexByName = new Map();
        let suggestionSource = [];
        let layerByName = new Map();
        const wardSearchInput = document.getElementById('ward-search');
        const wardSuggestions = document.getElementById('ward-suggestions');
        const clearWardSearchBtn = document.getElementById('clear-ward-search');
        const messageArea = document.getElementById('message-area');
        const populationInfo = document.getElementById('population-info');
        const populationInfoMobile = document.getElementById('population-info-mobile');
        const topWorstList = document.getElementById('top-worst-list');
        const topBestList = document.getElementById('top-best-list');
        const toggleTableBtn = document.getElementById('toggle-table-btn');
        const fullTableContainer = document.getElementById('full-table-container');
        const rankingQuickView = document.getElementById('ranking-quick-view');
        const rankingTitle = document.getElementById('ranking-title');
        const rankingPanelBody = document.getElementById('ranking-panel-body');
        const resultsState = document.getElementById('results-state');
        const rankingSearch = document.getElementById('ranking-search');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const paginationInfo = document.getElementById('pagination-info');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const cigaretteCountEl = document.getElementById('cigarette-count');
        const modeButtons = Array.from(document.querySelectorAll('.mode-btn'));
        const sortButtons = Array.from(document.querySelectorAll('button[data-sort-key]'));
        const mapLegendContainer = document.getElementById('map-legend');
        const sortIndicators = new Map();
        let wardSearchSizer = null;
        const MAX_VISIBLE_WARD_MATCHES = 5; // Increased for better UX
        let hanoiBounds = null;
        const modeMultipliers = { daily: 1, weekly: 7, monthly: 30 };
        let baseCigarettes = 0;
        let currentMode = 'daily';
        let rankingData = [];
        let rankingByName = new Map();
        let currentSort = 'aqi_desc';
        let currentPage = 1;
        let isFullTableVisible = false;
        
        sortButtons.forEach(btn => {
            const key = btn.dataset.sortKey;
            const indicator = document.querySelector(`[data-sort-indicator="${key}"]`);
            if (key && indicator) sortIndicators.set(key, indicator);
            btn.addEventListener('click', () => {
                if (!key) return;
                const [currentKey, currentDir] = currentSort.split('_');
                const nextDir = currentKey === key && currentDir === 'desc' ? 'asc' : 'desc';
                currentSort = `${key}_${nextDir}`;
                currentPage = 1;
                updateSortIndicators(key, nextDir);
                refreshRankingTable();
            });
        });
        const [initialSortKey, initialSortDir] = currentSort.split('_');
        updateSortIndicators(initialSortKey, initialSortDir);

        if (wardSearchInput) {
            wardSearchInput.disabled = true;
            setupWardSearchSizer();
            resizeWardSearchInput();
        }
        
        // --- HELPERS ---
        const formatDecimal = (value, fractionDigits = 1) => {
            if (!Number.isFinite(value)) return '—';
            return value.toFixed(fractionDigits).replace('.', ',');
        };
        
        const aqiColorScale = [
            { color: '#2ecc71', range: '0-50', label: 'Tốt' },
            { color: '#f1c40f', range: '51-100', label: 'Trung bình' },
            { color: '#f39c12', range: '101-150', label: 'Kém' },
            { color: '#e74c3c', range: '151-200', label: 'Xấu' },
            { color: '#8e44ad', range: '201-300', label: 'Rất xấu' },
            { color: '#5b2c6f', range: '300+', label: 'Nguy hại' }
        ];

        function renderMapLegend() {
            if (!mapLegendContainer) return;
            const heading = '<div class="legend-heading">AQI</div>';
            const columns = [
                aqiColorScale.slice(0, 3),
                aqiColorScale.slice(3)
            ];
            const content = columns.map(group => `
                <div class="legend-column">
                    ${group.map(item => `
                        <div class="legend-item">
                            <div class="legend-square" style="background-color: ${item.color};"></div>
                            <span class="legend-label">
                                <span class="legend-label-text">${item.label}</span>
                                <span class="legend-label-range">(${item.range})</span>
                            </span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            mapLegendContainer.innerHTML = heading + `<div class="legend-grid">${content}</div>`;
        }

        function updateSortIndicators(activeKey, direction) {
            sortIndicators.forEach((indicator, key) => {
                indicator.textContent = key === activeKey ? (direction === 'asc' ? '▲' : '▼') : '';
            });
        }

        function getWardName(properties = {}) {
            return properties.ten_phuong || properties.Name || properties.name || "Khu vực";
        }

        function getWardPopulation(properties = {}) {
            return parseNumericProperty(properties.Pop ?? properties.population ?? properties.pop);
        }

        function getWardAqi(properties = {}) {
            return parseNumericProperty(properties.AQI ?? properties.aqi_mean ?? properties.aqi ?? properties['Air Quality']);
        }

        function getWardPm25(properties = {}) {
            return parseNumericProperty(properties['PM2.5'] ?? properties.pm25_mean ?? properties.pm25);
        }

        function parseNumericProperty(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const normalized = value.replace(/\s/g, '').replace(/,/g, '.');
                const parsed = parseFloat(normalized);
                return Number.isFinite(parsed) ? parsed : 0;
            }
            return 0;
        }

        function setupWardSearchSizer() {
            if (!wardSearchInput || wardSearchSizer) return;
            wardSearchSizer = document.createElement('span');
            wardSearchSizer.className = 'absolute invisible whitespace-pre pointer-events-none';
            const computed = window.getComputedStyle(wardSearchInput);
            wardSearchSizer.style.font = computed.font;
            document.body.appendChild(wardSearchSizer); // Append to body to ensure width calc works
        }

        function resizeWardSearchInput() {
            if (!wardSearchInput) return;
            if (!wardSearchSizer) setupWardSearchSizer();
            
            if (window.innerWidth <= 640) {
                wardSearchInput.style.width = '100%';
                updateClearButtonVisibility();
                return;
            }

            const placeholder = wardSearchInput.getAttribute('placeholder') || '';
            const text = wardSearchInput.value || '';
            
            wardSearchSizer.innerText = (text.length > placeholder.length ? text : placeholder).replace(/\s/g, '\u00a0');
            
            // Add some buffer for cursor and aesthetic
            const maxWidth = window.innerWidth <= 640 ? 280 : 400;
            const newWidth = Math.min(Math.max(wardSearchSizer.offsetWidth + 30, 30), maxWidth);
            wardSearchInput.style.width = `${newWidth}px`;
            
            updateClearButtonVisibility();
        }

        function updateClearButtonVisibility() {
            if (!clearWardSearchBtn || !wardSearchInput) return;
            const hasValue = wardSearchInput.value.trim().length > 0;
            if (hasValue) {
                clearWardSearchBtn.classList.remove('hidden');
                wardSearchInput.classList.add('has-clear');
            } else {
                clearWardSearchBtn.classList.add('hidden');
                wardSearchInput.classList.remove('has-clear');
            }
        }

        function updateModeButtons() {
            modeButtons.forEach(btn => {
                const isActive = btn.dataset.mode === currentMode;
                btn.className = `mode-btn px-4 py-1.5 rounded-md text-sm font-bold transition-all duration-200 ${isActive 
                    ? 'bg-white text-orange-600 shadow-sm ring-1 ring-gray-200' 
                    : 'text-gray-400 hover:text-gray-600'}`;
            });
        }

        function updateCigaretteDisplay() {
            const multiplier = modeMultipliers[currentMode] ?? 1;
            const value = baseCigarettes * multiplier;
            if (cigaretteCountEl) {
                // Animate number counting if needed, for now just set
                cigaretteCountEl.innerText = formatDecimal(value, 1);
            }
        }

        function setBaseCigarettes(value) {
            baseCigarettes = value;
            updateCigaretteDisplay();
            updateModeButtons();
        }

        function setMode(mode) {
            if (!modeMultipliers[mode]) return;
            currentMode = mode;
            updateModeButtons();
            updateCigaretteDisplay();
        }

        function getHeatmapColor(aqi) {
            if (aqi <= 50) return '#2ecc71';
            if (aqi <= 100) return '#f1c40f';
            if (aqi <= 150) return '#f39c12';
            if (aqi <= 200) return '#e74c3c';
            if (aqi <= 300) return '#8e44ad';
            return '#5b2c6f';
        }

        function getWardStyle(properties = {}) {
            const aqi = getWardAqi(properties);
            return {
                color: '#ffffff',
                weight: 1,
                opacity: 0.4,
                fillColor: getHeatmapColor(aqi),
                fillOpacity: 0.7
            };
        }

        function pm25ToCigarettes(pm25) {
            if (typeof pm25 !== 'number' || pm25 < 0) return 0;
            return pm25 / 22;
        }

        // --- MAIN INITIALIZATION ---
        async function initializeMapAndData() {
            try {
                // Simulate loading or fetch real data
                const response = await fetch('./HanoiAQ.geojson');
                if (!response.ok) throw new Error(`Không thể tải dữ liệu.`);
                
                wardData = await response.json();
                buildFeatureLookups(wardData);

                const mapCenter = [21.0285, 105.8542];
                map = L.map('map', {
                    attributionControl: false,
                    zoomControl: false, 
                    minZoom: 9
                }).setView(mapCenter, 10);
                
                L.control.zoom({ position: 'bottomright' }).addTo(map);

                L.tileLayer('https://mt.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                    maxZoom: 18, minZoom: 9
                }).addTo(map);

                initializeWardSearch(wardData);

                geoJsonLayer = L.geoJSON(wardData, {
                    style: feature => getWardStyle(feature.properties),
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => {
                            const name = getWardName(feature.properties);
                            const idx = getFeatureIndexByName(name);
                            if (idx >= 0) selectWardByIndex(idx, { fitBounds: false, layer });
                        });
                        layer.on('mouseover', () => {
                            layer.setStyle({ weight: 2, color: '#333', opacity: 1 });
                        });
                        layer.on('mouseout', () => {
                            if (layer !== lastHighlightedLayer) {
                                geoJsonLayer.resetStyle(layer);
                            }
                        });
                        const layerName = getWardName(feature.properties);
                        if (layerName) layerByName.set(layerName, layer);
                        
                        const tooltipContent = `<div class="font-bold text-gray-800">${getWardName(feature.properties)}</div>
                                                <div class="text-xs">AQI: ${formatDecimal(getWardAqi(feature.properties), 0)}</div>`;
                        layer.bindTooltip(tooltipContent, { sticky: true, className: 'px-2 py-1 bg-white border border-gray-200 rounded shadow-sm text-xs' });
                    }
                }).addTo(map);

                hanoiBounds = geoJsonLayer.getBounds().pad(0.1);
                map.setMaxBounds(hanoiBounds);
                map.fitBounds(hanoiBounds);
                
                populateRanking(wardData);
            } catch (error) {
                console.error(error);
                showMessage("Không thể tải dữ liệu bản đồ.", 'error');
            }
        }

        // --- UI UPDATES ---
        let lastHighlightedLayer = null;
        
        function highlightLayer(layer) {
            if (lastHighlightedLayer && geoJsonLayer) {
                geoJsonLayer.resetStyle(lastHighlightedLayer);
            }
            if (layer) {
                layer.setStyle({ color: '#e85d04', weight: 3, opacity: 1, fillOpacity: 0.8 });
                layer.bringToFront();
                lastHighlightedLayer = layer;
            } else {
                lastHighlightedLayer = null;
            }
        }

        function clearWardSelection() {
            if (wardSearchInput) {
                wardSearchInput.value = '';
                resizeWardSearchInput();
                wardSearchInput.focus();
            }
            if (wardSuggestions) wardSuggestions.classList.add('hidden');
            updateClearButtonVisibility();
            highlightLayer(null);
            if (map && hanoiBounds) {
                map.fitBounds(hanoiBounds, { animate: true });
            }
            baseCigarettes = 0;
            if (cigaretteCountEl) cigaretteCountEl.innerText = '...';
            if (populationInfo) populationInfo.innerText = '';
            if (populationInfoMobile) populationInfoMobile.innerText = '';
        }

        function buildFeatureLookups(data) {
            featureIndexByName = new Map();
            suggestionSource = [];
            if (!data || !Array.isArray(data.features)) return;
            data.features.forEach((feature, index) => {
                const name = getWardName(feature.properties);
                if (!name) return;
                const normalized = name.trim().toLowerCase();
                if (!featureIndexByName.has(normalized)) featureIndexByName.set(normalized, index);
                suggestionSource.push({ name, normalized, index });
            });
            suggestionSource.sort((a, b) => a.name.localeCompare(b.name, 'vi'));
        }

        function initializeWardSearch(data) {
            if (!wardSearchInput) return;
            wardSearchInput.disabled = false;
            resizeWardSearchInput();
            updateClearButtonVisibility();
            
            wardSearchInput.addEventListener('focus', function() {
                this.select();
                updateWardSuggestions(this.value);
            });
        }

        function getFeatureIndexByName(name = '') {
            if (!name) return -1;
            return featureIndexByName.has(name.trim().toLowerCase()) ? featureIndexByName.get(name.trim().toLowerCase()) : -1;
        }

        function updateWardSuggestions(query = '') {
            if (!wardSuggestions) return;
            const trimmed = (query || '').trim().toLowerCase();
            const matches = (trimmed 
                ? suggestionSource.filter(s => s.normalized.includes(trimmed)) 
                : suggestionSource
            ).slice(0, MAX_VISIBLE_WARD_MATCHES);

            let suggestionsHtml = '';
            if (matches.length === 0) {
                suggestionsHtml = '<div class="p-3 text-sm text-gray-500 italic">Không tìm thấy kết quả</div>';
            } else {
                suggestionsHtml = matches.map(item => `
                    <div class="px-4 py-2.5 hover:bg-orange-50 cursor-pointer text-sm text-gray-700 border-b last:border-0 border-gray-50 transition-colors font-medium" 
                        data-index="${item.index}">
                        ${item.name}
                    </div>
                `).join('');
            }
            
            const locationOption = `
                <button type="button" data-location-option="true"
                    class="w-full flex items-center gap-2 px-4 py-3 text-sm font-bold text-orange-600 hover:bg-orange-50 border-b border-gray-100 transition-colors focus:outline-none bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                    Vị trí của tôi
                </button>
            `;

            wardSuggestions.innerHTML = locationOption + suggestionsHtml;
            wardSuggestions.classList.remove('hidden');
        }

        function selectWardByIndex(index, options = {}) {
            if (!wardData || index < 0 || index >= wardData.features.length) return;
            const feature = wardData.features[index];
            const name = getWardName(feature.properties);
            const { layer, fitBounds = true } = options;
            
            updateUI(feature.properties);
            
            if (wardSearchInput) {
                wardSearchInput.value = name;
                resizeWardSearchInput();
                wardSearchInput.blur();
                updateClearButtonVisibility();
            }
            if (wardSuggestions) wardSuggestions.classList.add('hidden');

            const targetLayer = layer || layerByName.get(name);
            if (targetLayer) {
                if (fitBounds && map) {
                    map.fitBounds(targetLayer.getBounds(), { padding: [50, 50] });
                }
                highlightLayer(targetLayer);
            }
        }

        function updateUI(properties) {
            const pm25 = getWardPm25(properties);
            const population = getWardPopulation(properties);
            const cigs = pm25ToCigarettes(pm25);

            setBaseCigarettes(cigs);

            const populationText = population > 0
                ? `Ảnh hưởng đến ${Math.round(population).toLocaleString('vi-VN')} người dân.`
                : '';
            if (populationInfo) populationInfo.innerText = populationText;
            if (populationInfoMobile) populationInfoMobile.innerText = populationText;
        }

        const isMobileViewport = () => window.innerWidth <= 640;
        const getQuickViewCount = () => isMobileViewport() ? 3 : 5;
        const getRowsPerPage = () => isMobileViewport() ? 5 : 9;

        // --- RANKING & TABLE LOGIC ---
        function populateRanking(data) {
            if (!data || !data.features) return;
            rankingData = data.features.map((f) => ({
                name: getWardName(f.properties),
                aqi: getWardAqi(f.properties),
                pm25: getWardPm25(f.properties),
                population: getWardPopulation(f.properties)
            })).filter(e => e.name && e.aqi > 0).sort((a, b) => b.aqi - a.aqi);

            rankingData.forEach((e, i) => e.rank = i + 1);

            renderQuickLists();
            refreshRankingTable();
        }

        function renderQuickLists() {
            if (!rankingData.length) return;
            const count = getQuickViewCount();
            if (topWorstList) {
                topWorstList.innerHTML = rankingData.slice(0, count).map(e => 
                    `<li class="flex justify-between"><span>${e.name}</span> <span class="font-bold text-red-600">${Math.round(e.aqi)}</span></li>`
                ).join('');
            }
            if (topBestList) {
                const best = [...rankingData].reverse().slice(0, count);
                topBestList.innerHTML = best.map(e => 
                    `<li class="flex justify-between"><span>${e.name}</span> <span class="font-bold text-green-600">${Math.round(e.aqi)}</span></li>`
                ).join('');
            }
        }

        function refreshRankingTable() {
            if (!rankingTableBody) return;
            let rows = [...rankingData];
            
            const search = rankingSearch ? rankingSearch.value.trim().toLowerCase() : '';
            if (search) rows = rows.filter(r => r.name.toLowerCase().includes(search));

            const [key, dir] = currentSort.split('_');
            rows.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (typeof valA === 'string' || typeof valB === 'string') {
                    const strA = (valA || '').toString();
                    const strB = (valB || '').toString();
                    return dir === 'asc' ? strA.localeCompare(strB, 'vi') : strB.localeCompare(strA, 'vi');
                }
                const numA = Number.isFinite(valA) ? valA : 0;
                const numB = Number.isFinite(valB) ? valB : 0;
                return dir === 'asc' ? numA - numB : numB - numA;
            });

            const rowsPerPage = getRowsPerPage();
            const totalPages = Math.ceil(rows.length / rowsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * rowsPerPage;
            const displayRows = rows.slice(start, start + rowsPerPage);
            
            rankingTableBody.innerHTML = displayRows.map(e => `
                <tr class="hover:bg-orange-50 transition-colors">
                    <td class="px-3 py-2 font-semibold text-gray-900">${e.name}</td>
                    <td class="px-3 py-2">
                        <span class="px-2 py-0.5 rounded text-xs font-bold text-white" style="background-color:${getHeatmapColor(e.aqi)}">
                            ${formatDecimal(e.aqi, 0)}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-gray-700 text-sm">${formatDecimal(e.pm25, 1)}</td>
                    <td class="px-3 py-2 text-gray-500 text-sm">${e.population ? e.population.toLocaleString('vi-VN') : '-'}</td>
                </tr>
            `).join('');

            if (paginationInfo) paginationInfo.innerText = `Trang ${currentPage}/${totalPages}`;
            if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
        }

        // --- EVENTS ---
        modeButtons.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
        
        if (wardSearchInput) {
            wardSearchInput.addEventListener('input', (e) => {
                resizeWardSearchInput();
                updateWardSuggestions(e.target.value);
            });
        }

        if (clearWardSearchBtn) {
            clearWardSearchBtn.addEventListener('click', (e) => {
                e.preventDefault();
                clearWardSelection();
            });
        }

        if (wardSuggestions) {
            wardSuggestions.addEventListener('mousedown', (e) => e.preventDefault());
            wardSuggestions.addEventListener('click', (e) => {
                const locationOption = e.target.closest('[data-location-option="true"]');
                if (locationOption) {
                    onLocationClick();
                    return;
                }
                const item = e.target.closest('div[data-index]');
                if (item) selectWardByIndex(parseInt(item.dataset.index, 10));
            });
        }
        
        document.addEventListener('click', (e) => {
            if (wardSearchInput && !wardSearchInput.contains(e.target) && 
                wardSuggestions && !wardSuggestions.contains(e.target)) {
                wardSuggestions.classList.add('hidden');
            }
        });

        if (toggleTableBtn && fullTableContainer && rankingQuickView) {
            toggleTableBtn.addEventListener('click', () => {
                isFullTableVisible = !isFullTableVisible;
                fullTableContainer.classList.toggle('hidden', !isFullTableVisible);
                rankingQuickView.classList.toggle('hidden', isFullTableVisible);
                toggleTableBtn.textContent = isFullTableVisible ? 'Quay lại xếp hạng nhanh' : 'Xem chi tiết tất cả';
                if (rankingTitle) rankingTitle.textContent = isFullTableVisible ? 'Bảng xếp hạng chi tiết' : 'Xếp hạng nhanh';
            });
        }

        if (prevPageBtn) prevPageBtn.addEventListener('click', () => { currentPage--; refreshRankingTable(); });
        if (nextPageBtn) nextPageBtn.addEventListener('click', () => { currentPage++; refreshRankingTable(); });
        if (rankingSearch) rankingSearch.addEventListener('input', () => { currentPage = 1; refreshRankingTable(); });
        window.addEventListener('resize', () => {
            renderQuickLists();
            refreshRankingTable();
        });

        function onLocationClick() {
            if (!navigator.geolocation) return showMessage("Trình duyệt không hỗ trợ vị trí.", 'error');
            showMessage("Đang tìm vị trí...", 'info');
            navigator.geolocation.getCurrentPosition(pos => {
                const userPoint = turf.point([pos.coords.longitude, pos.coords.latitude]);
                let found = null;
                geoJsonLayer.eachLayer(layer => {
                    if (!found && turf.booleanPointInPolygon(userPoint, layer.feature.geometry)) {
                        found = layer;
                    }
                });
                if (found) {
                    const idx = getFeatureIndexByName(getWardName(found.feature.properties));
                    selectWardByIndex(idx, { layer: found });
                } else {
                    showMessage("Bạn đang ở ngoài khu vực dữ liệu.", 'warn');
                }
            }, () => showMessage("Không thể truy cập vị trí.", 'error'));
        }

        function showMessage(msg, type) {
            messageArea.innerText = msg;
            messageArea.classList.remove('hidden');
            setTimeout(() => messageArea.classList.add('hidden'), 3000);
        }

        window.onload = () => {
            renderMapLegend();
            initializeMapAndData();
            updateModeButtons(); // Init buttons
        };
    </script>
</body>
</html>
